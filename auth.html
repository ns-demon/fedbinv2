<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Access Key - DogKey System</title>
    <link rel="stylesheet" href="https://dwcdatabase.com/static/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>DogGenator Key System</h1>
            <div class="user-info">
                <p>Welcome, <span class="username">qrcode1</span></p>
                <p class="discord-id">Discord ID: 1271586397576233034</p>
            </div>
        </header>

        <main class="main-content">
            <div class="cards-grid">
                <!-- 1 Hour Card -->
                <div class="key-card" data-duration="1">
                    <div class="card-header">
                        <h3>Quick Access</h3>
                        <span class="duration">1H</span>
                    </div>
                    <div class="card-body">
                        <p>Perfect for temporary access</p>
                        <div class="checkpoint-info">1 LootLabs content locker required</div>
                        <button class="generate-btn" onclick="generateKey(1)">Generate Key</button>
                    </div>
                </div>

                <!-- 6 Hours Card -->
                <div class="key-card" data-duration="6">
                    <div class="card-header">
                        <h3>Extended Access</h3>
                        <span class="duration">6H</span>
                    </div>
                    <div class="card-body">
                        <p>For longer work sessions</p>
                        <div class="checkpoint-info">2 LootLabs content lockers required</div>
                        <button class="generate-btn" onclick="generateKey(6)">Generate Key</button>
                    </div>
                </div>

                <!-- 24 Hours Card - Popular (spans full width) -->
                <div class="key-card popular" data-duration="24">
                    <div class="popular-badge">
                        <span>Most Popular</span>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h3>Full Day Access</h3>
                            <span class="duration">24H</span>
                        </div>
                        <div class="card-body">
                            <p>Maximum security and convenience</p>
                            <div class="checkpoint-info">4 LootLabs content lockers required</div>
                            <button class="generate-btn" onclick="generateKey(24)">Generate Key</button>
                        </div>
                        <div class="card-features">
                            <h4 style="color: #ffffff; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1rem;">Why Choose 24H?</h4>
                            <p style="color: #e5e5e5; font-size: 0.75rem; line-height: 1.6;">Just 5 minutes of verification for 24 hours of uninterrupted access. Much more useful than shorter keys.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkpoint Section -->
            <div class="checkpoint-section" id="checkpointSection" style="display: none;">
                <div class="result-header">
                    <h2>Complete LootLabs Verification</h2>
                    <p>Complete all content lockers to receive your access key</p>
                </div>

                <div class="checkpoint-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0 / 0 content lockers completed</div>
                </div>

                <div class="checkpoint-list" id="checkpointList">
                    <!-- Checkpoint links will be populated here -->
                </div>

                <div class="checkpoint-status" id="checkpointStatus">
                    <p>Complete each LootLabs content locker in order. Each step will open in a new window and close automatically when completed.</p>
                    <div class="lootlabs-info">
                    </div>
                </div>
            </div>

            <!-- Result Section -->
            <div class="result-section" id="resultSection" style="display: none;">
                <div class="result-header">
                    <h2>Your Access Key</h2>
                    <p>Copy and securely store your key</p>
                </div>

                <div class="key-display">
                    <div class="key-value" id="keyValue">
                        <!-- Generated key will appear here -->
                    </div>
                    <button class="copy-btn" onclick="copyKey()">Copy</button>
                </div>

                <div class="key-details">
                    <div class="detail-item">
                        <span class="label">Status</span>
                        <span class="value status-active">Active</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Duration</span>
                        <span class="value" id="keyDuration">0 Hours</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Expires</span>
                        <span class="value" id="keyExpires">--:--</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        Key copied to clipboard!
    </div>

    <script>
        const sessionId = "65e781ab-11aa-4356-9264-eb85050ce402";
        let checkpoints = [];
        
        // Check for existing progress on page load
        const hasExistingProgress = true;
        
        
       const existingProgress = {
    duration_hours: 24,
    checkpoints: [
        { completed: true, id: "d20a0d2f...", step: 1, ... },
        { completed: true, id: "39b1ffe0...", step: 2, ... },
        { completed: true, id: "f8da06a8...", step: 3, ... },
        { completed: true, id: "708631db...", step: 4, ... }
    ],
    completed_count: 4,
    total_count: 4,
    all_completed: true
};

        
        
        // Auto-load existing progress on page load
        window.addEventListener('DOMContentLoaded', function() {
            if (hasExistingProgress && existingProgress) {
                console.log('Loading existing progress:', existingProgress);
                
                // Check if all checkpoints are completed
                if (existingProgress.all_completed) {
                    // Show the final key section
                    getFinalKey();
                } else {
                    // Show the checkpoint section with current progress
                    showExistingCheckpoints(existingProgress);
                }
            }
        });
        
        function showExistingCheckpoints(progressData) {
            checkpoints = progressData.checkpoints;
            const checkpointSection = document.getElementById('checkpointSection');
            const checkpointList = document.getElementById('checkpointList');
            
            // Update progress
            updateProgress(progressData.completed_count, progressData.total_count);
            
            // Create checkpoint links with current status
            checkpointList.innerHTML = '';
            checkpoints.forEach((checkpoint, index) => {
                const checkpointDiv = document.createElement('div');
                checkpointDiv.className = 'checkpoint-item';
                
                const isCompleted = checkpoint.completed;
                const statusText = isCompleted ? '✅ Completed' : '⏳ Pending';
                const statusColor = isCompleted ? '#22c55e' : '#a1a1aa';
                const buttonText = isCompleted ? 'LootLabs Completed' : `Complete LootLabs Step ${checkpoint.step}`;
                const buttonDisabled = isCompleted ? 'disabled' : '';
                const buttonStyle = isCompleted ? 'opacity: 0.6;' : '';
                
                checkpointDiv.innerHTML = `
                    <div class="checkpoint-header">
                        <span class="checkpoint-number">${checkpoint.step}</span>
                        <span class="checkpoint-title">LootLabs Content Locker ${checkpoint.step}</span>
                        <span class="checkpoint-status" id="status-${checkpoint.id}" style="color: ${statusColor}">${statusText}</span>
                    </div>
                    <div class="checkpoint-description">
                        <p style="font-size: 0.75rem; color: #a1a1aa; margin: 0.5rem 0;">
                            GTA-themed gaming offers and recommendations
                        </p>
                    </div>
                    <button class="checkpoint-btn" onclick="openCheckpoint('${checkpoint.url}', '${checkpoint.id}')" 
                            id="btn-${checkpoint.id}" ${buttonDisabled} style="${buttonStyle}">
                        ${buttonText}
                    </button>
                `;
                checkpointList.appendChild(checkpointDiv);
            });
            
            checkpointSection.style.display = 'block';
            checkpointSection.scrollIntoView({ behavior: 'smooth' });
            
            const remainingCount = progressData.total_count - progressData.completed_count;
            if (remainingCount > 0) {
                showNotification(`Resumed session: ${remainingCount} LootLabs content lockers remaining`, 'info');
            } else {
                showNotification('All LootLabs content lockers completed! Getting your key...', 'success');
            }
        }
        
        // Listen for messages from LootLabs popup windows
        window.addEventListener('message', function(event) {
            if (event.data.type === 'checkpoint_completed') {
                handleCheckpointCompletion(event.data);
            }
        }, false);
        
        async function generateKey(duration) {
            const button = document.querySelector(`[data-duration="${duration}"] .generate-btn`);
            const originalText = button.textContent;
            
            // Show loading state
            button.innerHTML = '<span class="loading"></span>Creating LootLabs lockers...';
            button.disabled = true;
            
            try {
                const response = await fetch('/generate-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        duration_hours: duration
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showCheckpoints(data);
                } else {
                    showNotification('Error creating LootLabs content lockers', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to create content lockers', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        function showCheckpoints(data) {
            checkpoints = data.checkpoints;
            const checkpointSection = document.getElementById('checkpointSection');
            const checkpointList = document.getElementById('checkpointList');
            
            // Update progress
            updateProgress(0, data.total_checkpoints);
            
            // Create checkpoint links
            checkpointList.innerHTML = '';
            checkpoints.forEach((checkpoint, index) => {
                const checkpointDiv = document.createElement('div');
                checkpointDiv.className = 'checkpoint-item';
                checkpointDiv.innerHTML = `
                    <div class="checkpoint-header">
                        <span class="checkpoint-number">${checkpoint.step}</span>
                        <span class="checkpoint-title">LootLabs Content Locker ${checkpoint.step}</span>
                        <span class="checkpoint-status" id="status-${checkpoint.id}">⏳ Pending</span>
                    </div>
                    <div class="checkpoint-description">
                        <p style="font-size: 0.75rem; color: #a1a1aa; margin: 0.5rem 0;">
                            GTA-themed gaming offers and recommendations
                        </p>
                    </div>
                    <button class="checkpoint-btn" onclick="openCheckpoint('${checkpoint.url}', '${checkpoint.id}')" 
                            id="btn-${checkpoint.id}">
                        Complete LootLabs Step ${checkpoint.step}
                    </button>
                `;
                checkpointList.appendChild(checkpointDiv);
            });
            
            checkpointSection.style.display = 'block';
            checkpointSection.scrollIntoView({ behavior: 'smooth' });
            
            showNotification(`${data.total_checkpoints} LootLabs content lockers created!`);
        }
        
        function openCheckpoint(url, checkpointId) {
            // Open in new window with specific features
            const popup = window.open(url, '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
            
            // Update button state
            const button = document.getElementById(`btn-${checkpointId}`);
            const status = document.getElementById(`status-${checkpointId}`);
            
            button.textContent = 'Completing LootLabs...';
            button.disabled = true;
            status.textContent = '🔄 In Progress';
            status.style.color = '#ff6b35';
            
            // Check if popup was blocked
            if (!popup || popup.closed || typeof popup.closed == 'undefined') {
                showNotification('Popup blocked! Please allow popups and try again.', 'error');
                button.textContent = `Complete LootLabs Step ${checkpointId}`;
                button.disabled = false;
                status.textContent = '❌ Popup Blocked';
                status.style.color = '#ef4444';
            }
        }
        
        function handleCheckpointCompletion(data) {
            // Update the specific checkpoint status
            const status = document.getElementById(`status-${data.checkpointId}`);
            const button = document.getElementById(`btn-${data.checkpointId}`);
            
            if (status && button) {
                status.textContent = '✅ Completed';
                status.style.color = '#22c55e';
                button.textContent = 'LootLabs Completed';
                button.disabled = true;
                button.style.opacity = '0.6';
            }
            
            // Update progress
            updateProgress(data.completed, data.total);
            
            // Check if all completed
            if (data.allCompleted) {
                showNotification('All LootLabs content lockers completed! Generating your access key...', 'success');
                setTimeout(() => {
                    getFinalKey();
                }, 1500);
            } else {
                showNotification(`LootLabs content locker ${data.completed}/${data.total} completed!`, 'success');
            }
        }
        
        function updateProgress(completed, total) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${completed} / ${total} content lockers completed`;
        }
        
        async function getFinalKey() {
            try {
                const response = await fetch(`/final-key/${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    displayFinalKey(data);
                } else {
                    showNotification('Error getting final key', 'error');
                }
            } catch (error) {
                console.error('Error getting final key:', error);
                showNotification('Failed to get final key', 'error');
            }
        }
        
        function displayFinalKey(data) {
            // Hide checkpoint section
            const checkpointSection = document.getElementById('checkpointSection');
            checkpointSection.style.display = 'none';
            
            // Show result section
            const resultSection = document.getElementById('resultSection');
            const keyValue = document.getElementById('keyValue');
            const keyDuration = document.getElementById('keyDuration');
            const keyExpires = document.getElementById('keyExpires');
            
            keyValue.textContent = data.access_key;
            keyDuration.textContent = `${data.duration_hours} Hour${data.duration_hours !== 1 ? 's' : ''}`;
            
            const expiresDate = new Date(data.expires_at);
            keyExpires.textContent = expiresDate.toLocaleString();
            
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
            
            showNotification('🎉 Access key generated successfully via LootLabs!', 'success');
        }
        
        function copyKey() {
            const keyValue = document.getElementById('keyValue').textContent;
            navigator.clipboard.writeText(keyValue).then(() => {
                showNotification('Key copied to clipboard!');
            }).catch(() => {
                showNotification('Failed to copy key', 'error');
            });
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
    </script>
</body>
</html> 
